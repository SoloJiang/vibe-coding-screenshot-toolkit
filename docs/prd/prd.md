# 产品需求文档 (PRD)

(源自根目录 PRD.md v1.0，保持原始内容)

<!-- BEGIN ORIGINAL CONTENT -->
# 截图与标注工具 功能规格

文档版本：v1.0

---
## 1. 模块总览
| 模块代码 | 模块名称 | 目的 | 主要子域 |
|----------|----------|------|-----------|
| CAP | 截图采集 | 获取原始图像区域 | 全屏/窗口/区域/延时/连续 |
| SEL | 选区交互 | 用户框选与调整 | 拖拽/八向手柄/对齐线/多显示器 |
| ANO | 标注与图层 | 在截图上添加可编辑标注对象 | 图层模型/形状/文本/箭头/马赛克/自由笔/高亮 |
| EXP | 导出与分享 | 生成与分发最终输出 | 复制/保存/上传/Markdown/格式转换 |
| HIS | 历史库 | 管理最近截图 | 缩略图/检索/删除/打开 |
| OCR | 文本识别 | 从截图区域提取文本 | 语言检测/识别结果编辑 |
| PRIV | 隐私模糊 | 识别敏感信息并模糊 | 规则检测/提示/应用/撤销 |
| SET | 设置与快捷键 | 修改偏好与快捷键 | 快捷键冲突/命名模板/默认路径 |
| HOOK | 扩展 Hook | 导出后触发脚本 | Shell 参数传递/执行结果反馈 |
| CORE | 公共支撑 | 通用基础能力 | 图像缓存/撤销栈/颜色管理/ID 生成 |

---
## 2. 通用说明
对象命名：Screenshot -> 截图主对象；Annotation -> 标注对象；HistoryItem -> 历史条目。
标注对象公共属性：`id, type, frame{x,y,w,h}, rotation(0-359), opacity(0-1), strokeColor, fillColor, strokeWidth, shadow(bool), createdAt, zIndex, locked(bool)`
撤销/重做：所有对 Annotation 集合和选区几何的原子操作需入撤销栈。
坐标系：逻辑点（point）与最终像素（pixel）分离；导出时按显示器 scale 应用。

---
## 3. 功能明细

### 3.1 CAP 截图采集
| 编号 | 功能 | 用户故事 | 触发 | 主流程 | 关键规则 | 异常处理 | 验收 |
|------|------|----------|------|--------|----------|----------|------|
| CAP-01 | 全屏截图 | 我想瞬间获取所有屏幕内容 | 全局快捷键（默认 Cmd+Shift+1） | 捕获所有显示器图像 -> 合成或单屏 | 多显示器：默认当前光标所在显示器；按住 Option = 全部拼接 | 权限缺失 -> 弹权限提示 | 快速显示选区叠加或直接进入标注界面 |
| CAP-02 | 窗口截图 | 我想精确获取某个窗口 | 快捷键 Cmd+Shift+2 | 鼠标移动高亮窗口 -> 单击截取 | 高亮范围包含阴影；Cmd 点击可多选合并区域 | DRM/受保护窗口 -> 提示不可截 | 高亮响应 <50ms，合并区域正确 |
| CAP-03 | 自定义区域 | 我想框出任意区域 | 快捷键 Cmd+Shift+3 | 鼠标按下起点 -> 拖拽 -> 松开 | 最小尺寸 4x4 point；显示尺寸标签 | 拖拽越界自动裁剪 | 选区边界准确、尺寸标签跟随 |
| CAP-04 | 延时截图 | 我需要捕获菜单展开态 | 快捷键 Cmd+Shift+4 -> 选择 3s/5s | 倒计时浮层 -> 到时执行 CAP-01 或 CAP-02/03 最近模式 | 倒计时可 Esc 取消 | 倒计时取消 -> 无输出 | 延时精度 ±100ms |
| CAP-05 | 连续模式 | 我需要多张连续截图 | 激活后界面不退出 | 截图完成 -> 自动回到待截态 | 连续模式指示标记明显 | 用户退出（Esc） | 可连续截 >=10 次无资源泄露 |

补充规则：
1. 捕获接口优先使用系统 API，失败回退第二实现路径。
2. 截图原图保持无损缓存（PNG 或原始位图）。

### 3.2 SEL 选区交互
| 编号 | 功能 | 描述 | 主流程 | 规则 | 异常 | 验收 |
|------|------|------|--------|------|------|------|
| SEL-01 | 选区显示 | 显示半透明遮罩与选区矩形 | 截图后渲染遮罩+选区 | 遮罩透明度 0.4；选区内明亮 | 无 | 样式符合设计稿 |
| SEL-02 | 选区调整 | 用户拖动边/角改变尺寸 | 按下手柄 -> 拖拽 -> 松开 | Shift 保持比例；Alt 从中心缩放 | 小于最小尺寸 -> 忽略 | 几何更新平滑，无跳变 |
| SEL-03 | 移动选区 | 拖拽内部移动 | 按下内部 -> 拖动 | 吸附：对齐屏幕中心/边缘 5px | 超出屏幕自动限制 | 移动延迟 < 16ms |
| SEL-04 | 多显示器跨越 | 选区可跨屏 | 拖拽跨越时拆分坐标 -> 合并 | 输出导出时生成正确拼接 | 任一屏权限缺失 -> 阻断 | 跨屏像素无错位 |
| SEL-05 | 对齐参考线 | 显示中心/边缘辅助线 | 移动/缩放过程中计算 | 距离阈值 6px 触发 | 无 | 参考线显示/隐藏及时 |

### 3.3 ANO 标注与图层
#### 3.3.1 通用
| ID | 功能 | 描述 | 关键规则 | 验收 |
|----|------|------|----------|------|
| ANO-BASE-01 | 新增标注 | 选择工具后在画布单击或拖拽 | 创建对象入图层顶端，选中状态 | 对象创建后可立即编辑 |
| ANO-BASE-02 | 选中/多选 | 点击选中；Shift 多选 | 多选集合提供对齐/分布 | 多选操作不影响未选对象 |
| ANO-BASE-03 | 图层顺序 | 置顶/置底/上移/下移 | 更新 zIndex | 顺序变化即时渲染正确 |
| ANO-BASE-04 | 属性面板 | 显示当前对象可编辑属性 | 多选时灰显冲突属性 | 修改属性可撤销 |
| ANO-BASE-05 | 撤销/重做 | 操作入栈 | 栈最大 100 步 | 精准恢复状态 |

#### 3.3.2 各标注类型
| ID | 类型 | 创建方式 | 特有属性 | 规则 | 验收 |
|----|------|----------|----------|------|------|
| ANO-RECT | 矩形 | 拖出区域 | cornerRadius | 圆角默认 4，可调 0-16 | 渲染抗锯齿 |
| ANO-ARROW | 箭头 | 拖出起终点 | headSize,lineStyle | 线样式：实线/虚线 | 箭头指向准确 |
| ANO-TEXT | 文字 | 点击出现文本框 | fontFamily,fontSize,autoWrap | 自动根据背景反色；Enter 换行 | 文本编辑结束 Esc 退出 |
| ANO-HIGHLIGHT | 高亮 | 拖出区域 | blendMode | 叠加模式 Multiply/Screen | 与背景产生对比 |
| ANO-MOSAIC | 马赛克 | 拖出或笔刷 | mosaicLevel | 级别 1~3 对应像素块 6/12/18 | 不覆盖其他标注边界 |
| ANO-FREEHAND | 自由笔 | 拖动轨迹 | smoothing | 采样点间距阈值 2px | 线条平滑 |

#### 3.3.3 交互细节
1. 双击文本标注进入编辑模式。
2. Delete 删除选中；Backspace 行为等同。
3. 多选对齐：左/右/上/下/水平居中/垂直居中/平均分布。
4. 锁定标注：锁定后不可拖动与修改，右键菜单解锁。

### 3.4 EXP 导出与分享
| ID | 功能 | 用户故事 | 操作入口 | 规则 | 异常 | 验收 |
|----|------|----------|----------|------|------|------|
| EXP-01 | 复制图像 | 我想直接粘贴到 IM | 快捷键 Cmd+C / 按钮 | 默认 PNG，含所有标注 | 剪贴板写入失败 -> 重试一次 | 复制后可在外部粘贴成功 |
| EXP-02 | 复制为 JPEG | 体积更小 | 快捷键 Shift+Cmd+C | JPEG 质量默认 90 | 同上 | 得到 JPEG 且质量正确 |
| EXP-03 | 保存文件 | 保留到目录 | 保存按钮/快捷键 Cmd+S | 文件命名模板解析；存在重名 -> 序号递增 | 写入失败提示 | 文件存在且图像正确 |
| EXP-04 | 上传并复制 URL | 快速分享 | 上传开关开启后复制/保存同时触发 | 上传成功返回 url -> 写剪贴板；失败不影响本地 | 超时 -> 放弃上传提示 | URL 可访问图像 |
| EXP-05 | 复制 Markdown | 文档嵌入 | 菜单项 | 需要已有上传 URL；若无先执行上传 | 上传失败返回错误提示 | 剪贴板是合法 Markdown 链接 |
| EXP-06 | 命名模板解析 | 自定义命名 | 设置中配置 | 占位符 {date:yyyyMMdd-HHmmss}{seq}{screen} | 未知占位符忽略 | 生成符合预期 |

命名示例：`Screenshot-20250101-101530-1.png`。

### 3.5 HIS 历史库
| ID | 功能 | 描述 | 规则 | 边界 | 验收 |
|----|------|------|------|------|------|
| HIS-01 | 列表展示 | 显示最近 N=50 缩略图 | 倒序按创建时间 | 超过 50 自动移除最旧（可配） | 顺序正确 |
| HIS-02 | 预览 | 点击缩略图放大 | 预览支持再次复制/导出 | 原文件缺失 -> 标记失效 | 预览图清晰 |
| HIS-03 | 搜索 | 输入关键字过滤 | 按文件名/窗口标题匹配（模糊） | 空结果显示占位文案 | 过滤准确 |
| HIS-04 | 删除 | 移除历史 | 删除同时可选删除物理文件 | 物理删除失败 -> 仅移除索引 | 删除后列表刷新 |

### 3.6 OCR 文本识别
| ID | 功能 | 用户故事 | 规则 | 异常 | 验收 |
|----|------|----------|------|------|------|
| OCR-01 | 执行识别 | 我想复制图片里的文字 | 对当前选区或单独快捷键触发 | 自动检测中/英文；结果窗口可编辑 | 无文本 -> 提示“未检测到文本” | 返回文本可复制 |
| OCR-02 | 结果编辑 | 修改识别错字 | 结果窗口内直接编辑 | Cmd+Enter 确认复制并关闭 | 关闭前未复制 -> 保持窗口 | 编辑后复制内容正确 |

### 3.7 PRIV 隐私模糊
| ID | 功能 | 描述 | 规则 | 异常 | 验收 |
|----|------|------|------|------|------|
| PRIV-01 | 敏感检测 | 识别邮箱/手机号/长 token | 正则 & 长度阈值；每类型最多高亮 20 处 | 超过阈值显示“结果过多” | 高亮位置准确 |
| PRIV-02 | 一键模糊 | 对所有检测结果应用马赛克 | 生成 Mosaic 标注对象 | 已存在重叠标注 -> 调整 Z 顺序 | 所有命中均被覆盖 |
| PRIV-03 | 撤销模糊 | 恢复原状 | 撤销栈支持 | 无 | 撤销后图像还原 |

### 3.8 SET 设置与快捷键
| ID | 功能 | 描述 | 规则 | 验收 |
|----|------|------|------|------|
| SET-01 | 快捷键配置 | 修改全局快捷键 | 冲突检测：系统/应用内重复 -> 红色提示 | 保存后新快捷键立即生效 |
| SET-02 | 默认保存路径 | 选择目录 | 无权限 -> 引导授权 | 路径更新后新文件生效 |
| SET-03 | 最近颜色管理 | 记录最近 6 色 | 按使用时间更新顺序 | 颜色面板显示正确 |
| SET-04 | 命名模板编辑 | 文本输入校验占位符 | 非法占位符提示 | 生成示例实时刷新 |

### 3.9 HOOK 扩展
| ID | 功能 | 描述 | 规则 | 验收 |
|----|------|------|------|------|
| HOOK-01 | 导出后脚本 | 导出完成执行 shell | 传入参数：path / url（如存在） | 非 0 退出码 -> 显示失败通知 | 能被调用且返回码展示 |
| HOOK-02 | 超时控制 | 防止脚本卡死 | 最大执行 10s 超时终止 | 超时通知 | 超时被安全终止 |

### 3.10 CORE 公共支撑
| ID | 功能 | 描述 | 规则 | 验收 |
|----|------|------|------|------|
| CORE-01 | 撤销栈 | 存储操作快照 | 合并连续拖拽操作为 1 条 | 撤销/重做顺序正确 |
| CORE-02 | 图像缓存 | 暂存当前原始与合成图 | 关闭编辑器释放内存 | 导出使用缓存不失真 |
| CORE-03 | 颜色选择器 | 统一颜色组件 | 输出 HEX / RGBA | 写回标注属性成功 |
| CORE-04 | ID 生成 | 标注唯一 id | 使用 UUID 或时间戳+随机 | 无重复冲突 |

---
## 4. 状态与事件（精简）
| 事件代码 | 触发条件 | 说明 |
|----------|----------|------|
| EVT_CAPTURE_START | 任一截图动作开始 | 初始化撤销栈 |
| EVT_CAPTURE_DONE | 截图完成进入编辑 | 提供原始图句柄 |
| EVT_EXPORT | 导出动作 | 携带类型(copy/save/upload/markdown) |
| EVT_OCR_DONE | OCR 成功 | 携带文本长度 |
| EVT_PRIV_APPLY | 应用模糊 | 携带命中数量 |

---
## 5. 错误码（内部）
| Code | 场景 | 处理 |
|------|------|------|
| E_NO_PERMISSION | 缺少屏幕录制权限 | 弹权限引导对话框 |
| E_UPLOAD_FAIL | 上传失败 | Toast + 可重试按钮 |
| E_SAVE_FAIL | 文件保存失败 | 显示失败及目标路径 |
| E_OCR_EMPTY | 无文本 | 弹提示保留界面 |
| E_HOOK_TIMEOUT | 脚本超时 | 超时提示并终止进程 |

---
## 6. 验收清单（汇总）
1. 截图：全屏/窗口/区域/延时/连续均可使用与互不冲突。
2. 选区：调整、移动、跨屏、吸附、参考线正常。
3. 标注：6 类型创建/编辑/多选/属性修改/撤销重做/图层顺序 OK。
4. 导出：复制/保存/上传/Markdown 正常；命名模板解析正确。
5. 历史：记录、预览、搜索、删除行为符合规则。
6. OCR：识别 & 编辑流程可完成；无文本场景提示。
7. 隐私：检测、应用模糊、撤销可行。
8. 设置：快捷键冲突检测与保存生效。
9. Hook：导出后脚本在成功/失败/超时场景处理正确。
10. 公共：撤销栈、颜色选择、ID 唯一性符合预期。

---
## 7. 附录：占位符语法
`{date:yyyyMMdd-HHmmss}` 日期时间；`{seq}` 当日自增序号；`{screen}` 屏幕索引。未知占位符忽略。
示例：`Screenshot-{date}-{seq}.png`
<!-- END ORIGINAL CONTENT -->
