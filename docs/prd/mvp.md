# 截图与标注工具 MVP 产品需求文档 (PRD)

版本：v0.1-MVP

## 1. 目标
提供开发/内部测试可用的最小截图+基本标注+导出闭环，验证核心架构、性能基线与后续扩展可行性。

## 2. 范围 (In Scope)
| 域 | 功能 | 描述 | 验收要点 |
|----|------|------|----------|
| 截图 | 全屏截图 | 捕获当前主显示器像素（多显示器暂取光标所在） | 成功返回图像；失败给出权限/失败错误 |
| 截图 | 区域截图(裁剪) | 在全屏图像基础上按给定矩形裁剪 | 裁剪尺寸与请求一致；越界自动截断 |
| 标注 | 矩形 | 位置/尺寸/填充色/描边色/线宽 | 渲染正确；可撤销创建与修改 |
| 标注 | 箭头 | 起点终点+线宽+颜色 | 方向与坐标正确；可撤销 |
| 标注 | 文本(占位) | 文本内容+字体大小+颜色 | 文本块渲染不越界；可撤销 |
| 标注通用 | 撤销/重做 | 创建/修改/删除操作入栈(深度=100) | 连续拖拽合并为一条记录 |
| 标注通用 | 图层顺序简单 | zIndex 基于添加顺序；提供上移/下移 | 调整后渲染顺序正确 |
| 导出 | PNG 保存文件 | 依据命名模板生成文件名 | 文件存在且非 0 字节 |
| 导出 | PNG 复制剪贴板 | 将合成图推入系统剪贴板 | 粘贴到外部应用成功 |
| 导出 | 命名模板 | {date},{seq},{screen} | 同一天 seq 单调递增 |
| 历史 | 记录最近 N=50 | 保存 path/缩略图/创建时间 | 超过容量裁剪最旧 |
| 历史 | 启动加载 | 从持久化文件恢复 | 读取错误降级为空并记录日志 |
| CLI | capture 命令 | 全屏截图 -> 文件路径输出 | 返回 0 且打印路径 |
| CLI | capture-region | 区域截图 | 截图尺寸与输入匹配 |

## 3. 非范围 (Out of Scope / Later)
窗口高亮、延时、连续模式、OCR、隐私模糊、上传、Markdown 导出、JPEG 优化质量参数、Hook、快捷键自定义、GPU/SIMD 优化、DirtyRect、主题/设置 UI。

## 4. 关键规则
1. 命名模板未知占位符忽略。
2. 历史缩略图最大边长 240px（保持比例）。
3. Undo 合并：同一拖拽 session 使用统一 merge_key 合并。
4. 剪贴板失败重试 1 次；仍失败返回错误。
 5. （增强实现）seq 支持跨进程持久化：同目录下 .history/seq.txt 记录当天最后序号；非硬性验收项。

## 5. 错误码 (MVP 子集)
| Code | 场景 |
|------|------|
| E_NO_PERMISSION | 屏幕录制权限不足 |
| E_CAPTURE_FAIL | 捕获失败(其他原因) |
| E_SAVE_FAIL | 文件写入失败 |
| E_CLIPBOARD_FAIL | 剪贴板写入失败 |
| E_VALIDATION | 参数非法(区域越界等) |

## 6. 验收清单
1. CLI 可运行 capture / capture-region 生成文件。
2. 添加矩形/箭头/文本标注后可导出 PNG 并复制。
3. Undo/Redo 对新增与修改生效；连续拖拽只产生一条记录。
4. 命名模板 {seq} 在同日多次导出递增。
5. 历史列表只保留最近 50 条并含缩略图。

## 7. 指标 (可选观测)
- 单次全屏截图 + 渲染 + 导出耗时 < 300ms (1080p 参考)。
- Undo 操作耗时 < 5ms。

## 8. 后续扩展挂钩
文档保留与完整版 PRD 对应的 ID 映射位置，后续增量：CAP-02/04/05, ANO-HIGHLIGHT/MOSAIC/FREEHAND, EXP-02/03/04/05/06, HIS-02/03/04, OCR-*, PRIV-*, SET-*, HOOK-*, HOOK-02, CORE-02+ 性能优化。

