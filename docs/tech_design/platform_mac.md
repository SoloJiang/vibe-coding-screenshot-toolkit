# platform_mac 模块技术设计

## 职责
专注于交互式框选截图，支持多显示器环境。基于自研 UI overlay 提供的区域选择，进行精确的截图裁剪。

## 能力
- **交互式截图**：集成 ui_overlay 框选器，用户交互选择区域后进行截图
- **多显示器感知**：自动检测多显示器环境，支持在主显示器上进行交互
- **跨显示器支持**：（规划中）支持选择跨越多个显示器的区域
- **剪贴板集成**：写入 PNG 到 macOS NSPasteboard

注：移除了全屏捕获、区域截图、批量截图等功能，专注于交互式体验。

## 捕获策略 (基于 XCap)
使用 `xcap` (基于 CoreGraphics) 获取显示器图像作为交互背景。当前以主显示器为交互界面，未来扩展支持跨显示器选择。

**xcap 路径说明：**
- 成熟稳定的 Rust 生态库
- 基于 CoreGraphics，性能优秀
- 良好的多显示器支持
- 社区活跃，维护良好

## 交互式截图架构

### 流程设计
1. **显示器检测**：使用 `xcap::Monitor::all()` 枚举显示器
2. **主显示器交互**：在主显示器上捕获截图作为选择器背景
3. **用户交互**：通过 ui_overlay::RegionSelector 进行区域选择
4. **区域裁剪**：基于用户选择的区域，从原始截图中裁剪目标区域
5. **结果输出**：生成 Screenshot 对象供后续处理

### 多显示器增强（规划）
- **虚拟桌面坐标**：支持跨显示器的统一坐标系统
- **跨显示器选择**：允许用户选择跨越多个显示器的区域
- **智能合成**：自动检测选择区域涉及的显示器，进行合成截图

## 组件
- `MacCapturer`：核心截图实现
- `MacClipboard`：剪贴板集成

## 错误映射
权限不足 -> E_NO_PERMISSION；捕获失败 -> E_CAPTURE_FAIL；用户取消 -> 用户友好的取消消息。

## 风险
| 风险 | 缓解 |
|------|------|
| 权限阻塞 | 首次失败提示用户授权；授权后重试 |
| 多显示器尺寸/scale | 记录 scale 信息，正确处理 DPI 差异 |
| 跨显示器坐标复杂度 | 分阶段实现：先支持单显示器，再扩展跨显示器 |
| 显示器配置动态变化 | 每次捕获时重新枚举显示器列表 |
